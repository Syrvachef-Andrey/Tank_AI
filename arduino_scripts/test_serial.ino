// sudo chmod a+rw /dev/ttyUSB0
#include "Servo.h"

Servo servox;
int past_angle_x = 90;
int angle_x;
double koeff = 1.25;
const int numReadings = 5; // ?????????? ???????? ??? ??????????
int readings[numReadings]; // ?????? ??? ???????? ????????
int readIndex = 0;         // ??????? ?????? ? ???????
int total = 0;             // ????? ????????
int average = 0;           // ??????????? ????????

void setup() {
  servox.attach(10);
  Serial.begin(115200);
  delay(3000);

  // ????????????? ??????? ??? ??????????? ????????
  for (int i = 0; i < numReadings; i++) {
    readings[i] = 90;
    total += readings[i];
  }
}

void loop() {
  if (Serial.available() > 0) {
    String message = Serial.readStringUntil('\n');
    message.trim();

    int values[3];
    int index = 0;
    int start = 0;
    int end = message.indexOf(',');

    while (end != -1 && index < 3) {
      values[index] = message.substring(start, end).toInt();
      start = end + 1;
      end = message.indexOf(',', start);
      index++;
    }

    if (index < 3) {
      values[index] = message.substring(start).toInt();
    }

    Serial.print("Received values: ");
    for (int i = 0; i < 3; i++) {
      Serial.print(values[i]);
      if (i < 2) Serial.print(", ");
    }
    Serial.println();

    angle_x = values[0];

    // ?????????? ???????
    total = total - readings[readIndex]; // ??????? ?????? ????????
    readings[readIndex] = angle_x;       // ????????? ????? ????????
    total = total + readings[readIndex]; // ????????? ?????
    readIndex = (readIndex + 1) % numReadings; // ????????? ? ?????????? ???????
    average = total / numReadings;       // ????????? ???????

    // ??????? ????????? ????
    int step = (average > past_angle_x) ? 1 : -1; // ??? ????????? ????
    for (int i = past_angle_x; i != average; i += step) {
      servox.write(i);
      delay(15); // ???????? ??? ?????????
    }
    past_angle_x = average;
  }
}